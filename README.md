# Magento deployment on AWS using ECS/Fargate, RDS, OpenSearch, and EFS deployed with CDK

The goal of this sample project is to provide infrastructure as code based on AWS CDK in order to run open-source commerce Magento software platform.
Magento is a software platform that's designed for running commerce workloads.
This sample project will cover how to host a Magento Opensource e-commerce application using AWS Fargate and several additional AWS services allowing to run a produciton-ready well-architected and secure solution.

## Reference architecture

The following diagram shows the high-level architecture

![magento Architecture](doc/images/magento-archi.png)

The Magento platform consist of several core and optional components:

- A web server capable of supporting PHP-based applications, such as Apache or nginx
- The database server MySQL (we will uses AWS RDS Aurora service)
- ElasticSearch (we will uses AWS OpenSearch to handle this function)
  Optional components for Magento includes:
- A page caching mechanism (we will uses AWS ElastiCache)
- A session storage mechanism (we will uses AWS ElastiCache)

For this implementation, we rely on Magento open-source packaged into docker containers by Bitnami's [bitnami-docker-magento](https://github.com/bitnami/bitnami-docker-magento) project

All this architecture is created as code using AWS Cloud Development Kit (CDK) using Typescript flavour, the components are deployed as follows:

- The web application is deployed on AWS ECS container orchestrator using AWS Fargate serverless infrastructure.
  - Magento Service which will expose tasks from an AWS Load Balancer
  - Magento Admin Service which can be used for administrative tasks thanks to the `ecs exec` features, allowing administrators to connect into the admin task.
  - Fargate can scale up and down thanks to ECS Autoscaling mechanism to adapt your infrastructure with the incoming load on the load balancers.
- The Application Load Balancing directs incoming requests directly to the web application service tasks.
- The database component is hosted in Amazon Aurora MySQL compatible service.
- The Magento search feature will be powered by Amazon OpenSearch service (compatible with ElasticSearch)
- In order to accelerate page loads and provide Global access for customers, the application load balancer will be fronted by Amazon CloudFront service, on which we can enable AWS WAF security features to protect the commerce site.
- In order to accelerate page loads and provide Global access for customers, the application load balancer will be fronted by Amazon CloudFront service, on which we can enable AWS WAF security features to protect the commerce site.
- An Amazon Route53 Hosted zone must exist and will be configured for the magento subdomain on which the application will be exposed.
- The TLS communication will be handled by an AWS Certificat Manager certificat.
- AWS Secrets Manager will be used to store severals secrets generated by the CDK (Magento password, databases secrets) and some external secrets that can be necessary (Magento Account credentials)

## The project is Bootstrap with Projen and rely on CDK

### Projen installation

```bash
npm install -g yarn
npx npm install projen
```

#### how this project was bootstrap with Projen (just for information):

```bash
$ git init
$ npm init -y
$ npm i projen -D   
$ npx projen new awscdk-app-ts
```

The previous command created the `.projenrc.js` project configuration file.

From this file projen can generate our application directory structure with:

```bash
npx projen
```

You can create alias to launch projen:

```bash
alias pj='npx projen'
```
then execute `pj` to bootstrap or upgrade your project.

```bash
pj
```

### Project Pre-requisites

You will need to create AWS Secrets for Magento MarketPlace Credentials.

First If you don't already have one create account on https://devdocs.magento.com/guides/v2.3/install-gde/prereq/connect-auth.html and then you will create secrets from Magento Access Keys in AWS SecretManager with Secret name : **MAGENTO_MARKETPLACE** and value/pair:

```
| Secret key  | Secret Value                      |
| ----------- | --------------------------------- |
| private-key | **private-key-from-magento-site** |
| public-key  | **public-key-from-magento-site**  |
```

### Project Configuration

First of all, you must specify a stack name that would be used to create your stack. This is done with an environment parameter `CDK_STACK_NAME` which defaults to `magento`.

```bash
export CDK_STACK_NAME=magento
```

> **IMPORTANT** Note $CDK_STACK_NAME is also used to create database name, and domain names, so valid characters are a-z (lowercase only), 0-9

This variable can exported in your environment before creating the stack.
Other resources, can also be created based on the stack name, but you can also control this using the CDK context parameters used through Projen, see below:

In the `.projenrc.js` file you can configure how the stack will be deployed inside your AWS Account.

After updating the **context** section you will need to run again `pj` in order to generate the appropriate cdk.json file from the Projen bootstrap structure.

```json
...
  context: {
    //vpc_tag_name: 'ecsworkshop-base/BaseVPC', // TAG Name of the VPC to create the cluster into (or 'default' or remove to create new one)
    //enablePrivateLink: 'true',
    useEFS: 'no', // if true, /bitnami/magento directory will be mapped to a new empty EFS volume.

    //os_domain_endpoint: 'search-magento-zwa5v3x4br3kgn4y5e5nu6hv7q.eu-west-1.es.amazonaws.com', // Use Existing OS domain
    //os_domain: 'magento-cdk', // default to $CDK_STACK_NAME
    os_master_user_name: 'magento-master-os',

    //db_name: 'magento', // default to env $CDK_STACK_NAME
    db_user: 'magentodbuser',

    route53_domain_zone: 'your-hosted-zone.route53.com',
    //route53_magento_prefix: 'magento', // default to $CDK_STACK_NAME
    //route53_eksutils_prefix: 'eksutils', // default to $CDK_STACK_NAME-eksutils

    magento_user: 'user1',
    magento_admin_task: 'yes',
    magento_admin_task_debug: 'no',
  },
  ...
```

- **vpc_tag_name** : You can specify a tag name to use existing VPC, or ommit this parameter to create new VPC from CDK
- **enablePrivateLink** if true, enable VPC service endpoints for Cloudwatch, EFS, SecretManager. (@default: no)
- **useEFS** yes/no. if yes, create an EFS volume for /bitnami/magento directory (@default: no)

OpenSearch cluster parameters (password is generated by CDK and stored in SecretManager with name "$CDK_STACK_NAME-magento-opensearch-admin-password"):

- **os_domain_endpoint**: (OPTIONAL) If you have existing OpenSearch server you want to reuse, else create new OpenSearch domain.
- **os_domain** : the name of the OpenSearch Cluster that the cdk stack will create for you (@default: <stack_name>)
- **os_master_user_name**: the name for the master
- TODO: make rise of os_master_user_password

RDS Database (password is generated by CDK and stored in SecretManager with name "$CDK_STACK_NAME-magento"):

- **db_name**: the name of the db to create (@default: $CDK_STACK_NAME)
- **db_user**: the name of the db user (@default: magentouser)

ECS Cluster

- **route53_domain_zone** (MANDATORY) needs to specify the Route53 zone you want to use to deploy your services
- **route53_magento_prefix**: prefix to uses for exposing Magento service (@default: $CDK_STACK_NAME)
- **route53_eksutils_prefix**: prefix to uses for exposing the Eksutils service (@default: $CDK_STACK_NAME-eksutils )

> **You need to have prior to this created a wildcard certificate for your route53 zone in Certificate Manager and store this arn in Parameter store with key `CertificateArn-<route53_domain_zone>`**

Magento (password is generated by CDK and stored in SecretManager with name "<stackname>-magento-database-password"):)

- **magento_user**: magento user (@default: magento)
- **magento_admin_task**: yes/no - start admin magento service used to bootstrap magento with with `MAGENTO_DEPLOY_STATIC_CONTENT=yes`, `MAGENTO_SKIP_REINDEX=no`, `MAGENTO_SKIP_BOOTSTRAP=no` (@default yes)
- **magento_admin_task_debug**: yes/no - start admin magento service with just bash (not running magento instance) for debugging or executing scripts (@default no)

## Generate and deploy

Synthesize and generate the CloudFormation template from the CDK Typescript code:

```bash
make synth
```

Deploy the stack into your AWS account

```bash
make deploy
```

If you don't have `make`you can still directly uses

Example: if you want to build and test the application

```bash
pj build
```

If you want to deploy

```bash
pj deploy
```

The deploy action will apply the CDK generated CloudFormation template to your AWS Account. (Note, the services deployed here will incur costs in your account).

## TroubleShoot and debug

### Exec into the task

ECS allows you to exec into a task to have a shell inside your container.
The stack correctly configures the tasks so that you can securely connect inside.

The CloudFomation stack shows you some commands so that you can directly use to exec inside your tasks.

the Makefile can also show you these commands:

```bash
make connect
```

The printed commands can be used to exec into your containers. It uses a helper function that you can put in your PATH or simply source:

```bash
source src/helper.sh
ecs_exec_service magento MagentoServiceDebug magento
```

In case of errors during the connection, you still can use [ecs-exec-checker](https://github.com/aws-containers/amazon-ecs-exec-checker) tool to figure out where the problem is.

### Connect to the Magento Debug Task

If you activate the context parameter `magento_debug_task` then the Stack creates a dedicated Service that is deployed with all same parameters as the Magento task, except, that it doesn't start Magento and don't get exposed through a load balancer. But it is linked with the same, DB, same Opensearch, and the same Elastic Fils system.

You can use this task to interact with your Magento setup or debug things.

### Troubleshoot first install

When Magento starts, it will execute the following command:

```bash
/opt/bitnami/scripts/magento/entrypoint.sh /opt/bitnami/scripts/magento/run.sh
```

cd /bitnami/magento
bin/magento config:set web/unsecure/base_url http://ecs-magentodevmagentoservice-1199457188.eu-west-1.elb.amazonaws.com/

/bitnami/magento/var/report/1ab7538d9aa5309f92df556c729a9fe89c10612be583df2df42266059cf3c76b

TODO: which folders to share
chown -R daemon:daemon /bitnami/magento/
{var,pub,media}

If the Task didn't start properly, you can exec into the debug pod and manually execute the previous command to help figure out where comes the problem is. This can be credentials issues, passwords format like for example :

```
In SearchConfig.php line 81:

  Could not validate a connection to Elasticsearch. Could not parse URI: "htt
  ps://magento-master-os:beavqpdh.Kzm4?6WqtJHv4e0Lj3AioyI@search-magento-zwa5
  v3x4br3kgn4y5e5nu6hv7q.eu-west-1.es.amazonaws.com:443"

```

### Install magento demo content

If you want to install specific Magento content, you can use the magentoDebug service to connect into.
Use the Cdk output (or CloudFormation output in console) to get the connect command:exemple : `ecs_exec_service magento2 magento2-MagentoServiceDebugmagentoServiceMagentoServiceDebugService7B086C58-Danj7j20EkiI magento`

This will create a secure shell (The session is encrypted with a dedicated AWS KMS key generated for you by CDK) within your tasks, and all your commands will be stored in a dedicated CloudWatch log group (/ecs/secu/exec/${CDK_STACK_NAME})

Example commands to install Magento sample data (https://github.com/magento/magento2-sample-data):

cat << EOF>setup.sh
cd /bitnami/magento
su daemon -s /bin/bash
bin/magento maintenance:enable
mkdir -p /bitnami/magento/var/composer_home/
cat <<END > /bitnami/magento/var/composer_home/auth.json
{
"http-basic": {
"repo.magento.com": {
"username": "74d07c77fe347bc1bb0746dd07b19391",
"password": "e4132f07cff230a6bb4c1f913008b20f"
}
}
}
END
php -d memory_limit=-1 bin/magento sampledata:deploy
php -d memory_limit=-1 bin/magento setup:upgrade
php -d memory_limit=-1 bin/magento setup:static-content:deploy -f
php -d memory_limit=-1 bin/magento catalog:image:resize
chown -R daemon:daemon /bitnami/magento/
bin/magento maintenance:disable
EOF

```bash

php -d memory_limit=-1 bin/magento sampledata:deploy
#credential from repo.magento.com /bitnami/magento/var/composer_home/auth.json
#TODO: create this file from secretmanager
mkdir -p /bitnami/magento/var/composer_home/
cat <<EOF > /bitnami/magento/var/composer_home/auth.json
{
    "http-basic": {
        "repo.magento.com": {
            "username": "74d07c77fe347bc1bb0746dd07b19391",
            "password": "e4132f07cff230a6bb4c1f913008b20f"
        }
    }
}
EOF
chown daemon:daemon /bitnami/magento/var/composer_home/auth.json

php -d memory_limit=-1 bin/magento setup:upgrade

php -d memory_limit=-1 bin/magento setup:static-content:deploy -f

php -d memory_limit=-1 bin/magento catalog:image:resize
```

> TODO: deploy sample datas from Dockerfile startup script instead

> TODO: describe how to activate maintenance mode

### Set developper mode

```
php bin/magento deploy:mode:set developer
```

### Update Magento URL manually

Using Magento

```
su daemon -s /bin/bash
cd /bitnami/magento
bin/magento config:set web/unsecure/base_url http://ecs-magento44MagentoService-1674857408.eu-west-1.elb.amazonaws.com
```

bin/magento config:set web/secure/base_url https://$MAGENTO_HOST/
bin/magento config:set web/unsecure/base_url http://$MAGENTO_HOST/

bin/magento config:show web/secure/base_url
bin/magento config:show web/unsecure/base_url

Test it:
curl -H "Host: $MAGENTO_HOST" localhost:8080

Check in DB

```
#Connect to the DB
mysql -h $MAGENTO_DATABASE_HOST -u$MAGENTO_DATABASE_USER -p$MAGENTO_DATABASE_PASSWORD -D $MAGENTO_DATABASE_NAME

#query to update
UPDATE core_config_data SET value = 'http://www.example.com/' WHERE path LIKE 'web/unsecure/base_url';
UPDATE core_config_data SET value = 'https://www.example.com/' WHERE path LIKE 'web/secure/base_url';
```

check conf

```
select * from core_config_data WHERE path LIKE 'web/unsecure/base_url';
select * from core_config_data WHERE path LIKE 'web/secure/base_url';
select * from core_config_data WHERE path LIKE 'web/%';
```

### Debug Magento Apache configuration

Check Magento config:

```
php bin/magento config:show
```

Configuration files are :

```
# /opt/bitnami/apache/conf/httpd.conf
# /opt/bitnami/apache/conf/extra/httpd-default.conf
# /opt/bitnami/apache/conf/vhosts/*.conf
# /opt/bitnami/apache/conf/bitnami/bitnami.conf
# /opt/bitnami/apache/conf/bitnami/php.conf
# /opt/bitnami/magento/app/etc/env.php
```

# Troubleshoot Magento

uses the script to exec into the task

```
ecs_exec_service magento magento-magentoService27FB24D3-VIUJrhZwrS2S magento
```

debug commands

```
apt-get update && apt-get install -y vim
set -o xtrace
/opt/bitnami/scripts/magento/setup.sh | less
source /opt/bitnami/scripts/magento/setup.sh  | more
```

magento execute this script at startup : `/bin/bash /opt/bitnami/scripts/magento/setup.sh`

## MAgento Erros logs

```4635901b0f3cf830e5d49630a644dc70b4ec454dbdc4b41e18d5f0437a0320d6





16:31
I find error logs at  /bitnami/magento/var/report/1a267331567e6b7872ad4e146da68d8125937220e558650d66e2a12c063668cc
```

## Mysql

ensure_dir_exists /bitnami/magento
configure_permissions_ownership /bitnami/magento -d 775 -f 664 -u daemon -g root
magento_wait_for_db_connection $MAGENTO_DATABASE_HOST 3306 magento magentouser 'Passw0rd!'

mysql -h $MAGENTO_DATABASE_HOST -u $MAGENTO_DATABASE_USER -p$MAGENTO_DATABASE_PASSWORD $MAGENTO_DATABASE_NAME

## Elasticsearch

You can test the OpenSearch connection with curl:

```
curl -XPOST -u "$MAGENTO_ELASTICSEARCH_USER:$MAGENTO_ELASTICSEARCH_PASSWORD" "https://$ELASTICSEARCH_HOST/_search" -H "content-type:application/json" -d'
{
"query": {
"match_all": {}
}
}'
```

### Deleting the Stack

The stack is configured to delete the database cluster and OpenSearch cluster, and EFS file system. If you want to be able to keep the data, you will need to update the **removalPolicy** policies of those services in the CDK code.

```typescript
    const db = new DatabaseCluster(this, 'ServerlessWordpressAuroraCluster', {
      engine: DatabaseClusterEngine.AURORA_MYSQL,
      credentials: Credentials.fromPassword(DB_USER, secret),
      removalPolicy: RemovalPolicy.DESTROY, // <-- you can change this -->
      instanceProps: {
        vpc: vpc,
        securityGroups: [rdsSG],
      },
      defaultDatabaseName: DB_NAME,
    });
    ...

    const osDomain = new opensearch.Domain(this, 'Domain', {
      version: opensearch.EngineVersion.OPENSEARCH_1_0,
      domainName: OS_DOMAIN,
      //accessPolicies: [osPolicy], // Default No access policies
      removalPolicy: RemovalPolicy.DESTROY, // <-- you can change this -->
      securityGroups: [openSearchSG],
    ...

    const efsFileSystem = new FileSystem(this, 'FileSystem', {
      vpc,
      securityGroup: efsFileSystemSecurityGroup,
      performanceMode: PerformanceMode.GENERAL_PURPOSE,
      lifecyclePolicy: LifecyclePolicy.AFTER_30_DAYS,
      throughputMode: ThroughputMode.BURSTING,
      encrypted: true,
      removalPolicy: RemovalPolicy.DESTROY,// <-- you can change this -->
    });
```

While we can't delete an ECS Capacity Provider when associated Autoscaling Group still exists, the first attempt to delete the stack may be finished in a `DELETE_FAILED` state. A second delete attempt should properly delete everything.

# others errors when booting magento

## file is not writable

> cache_dir "/bitnami/magento/var/page_cache" is not writable

This cqn be fixed zith:

```
chown -R daemon:daemon /bitnami/magento/
```

## Exception printing is disabled by default for security reasons.

>    <p>Error log record number: 1a267331567e6b7872ad4e146da68d8125937220e558650d66e2a12c063668cc</p>

If you get an error like :

you can find detail in

```
more /bitnami/magento/var/report/fda2fb351f5f24a153b0eec1598483b69e5250559f03e2d0561a365fdfe2b3d0</p></p>
```

curl -v -H "Host: $MAGENTO_HOST" localhost:8080

### Unable to retrieve deployment version of static files from the file system

this can be fixed with commands

```
cd /bitnami/magento
php bin/magento setup:upgrade
php bin/magento setup:static-content:deploy -f
php bin/magento cache:flush
```

php bin/magento cache:clean

php bin/magento cache:flush
php bin/magento setup:upgrade

php bin/magento setup:static-content:deploy -f

setup:di:compile ?

### error entrypoint

Impossible to process constructor argument Parameter #2 [ <required> Magento\Framework\Mview\ViewFactory $viewFactory ] of Magento\Framework\Mview\TriggerCleaner class
